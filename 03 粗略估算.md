在系统设计面试中，有时会要求你使用粗略估计来估计系统容量或性能要求。谷歌高级研究员杰夫·迪恩 (Jeff Dean) 表示，“粗略计算是你使用思想实验和常见性能数据相结合创建的估计值，以便很好地了解哪些设计将满足你的要求”[1]。

你需要对可扩展性基础知识有很好的了解，才能有效地进行粗略估计。应该很好地理解以下概念：二的幂 [2]、每个程序员都应该知道的延迟数字以及可用性数字。

## 2 的幂

尽管在处理分布式系统时数据量可能会变得巨大，但计算都归结为基础。为了获得正确的计算结果，了解使用 2 次方的数据量单位至关重要。一个字节是 8 位的序列。一个 ASCII 字符使用一个字节的内存（8 位）。下面是解释数据量单位的表格（表1）。

| 力量 | 近似值   | 全名     | 简称 |
| :--- | :------- | :------- | :--- |
| 10   | 1 千     | 1 KB     | 1KB  |
| 20   | 百万     | 1兆字节  | 1MB  |
| 30   | 1十亿    | 1GB      | 1GB  |
| 40   | 1万亿    | 1 太字节 | 1TB  |
| 50   | 1 千万亿 | 1 PB     | 1PB  |

表格1

## 每个程序员都应该知道的延迟数字

Google 的 Dean 博士揭示了 2010 年典型计算机操作的长度[1]。随着计算机变得更快、更强大，一些数字已经过时了。然而，这些数字仍然应该能够让我们了解不同计算机操作的快慢。

| 操作名称                                | 时间                        |
| :-------------------------------------- | :-------------------------- |
| L1缓存参考                              | 0.5纳秒                     |
| 分支错误预测                            | 5纳秒                       |
| L2缓存参考                              | 7纳秒                       |
| 互斥锁/解锁                             | 100纳秒                     |
| 主内存参考                              | 100纳秒                     |
| 使用 Zippy 压缩 1K 字节                 | 10,000 纳秒 = 10 微秒       |
| 通过 1 Gbps 网络发送 2K 字节            | 20,000 纳秒 = 20 微秒       |
| 从内存中顺序读取 1 MB                   | 250,000 纳秒 = 250 微秒     |
| 同一数据中心内的往返                    | 500,000 纳秒 = 500 微秒     |
| 磁盘寻道                                | 10,000,000 纳秒 = 10 毫秒   |
| 从网络顺序读取 1 MB                     | 10,000,000 纳秒 = 10 毫秒   |
| 从磁盘顺序读取 1 MB                     | 30,000,000 纳秒 = 30 毫秒   |
| 发送数据包 CA（加利福尼亚州）->荷兰->CA | 150,000,000 纳秒 = 150 毫秒 |

表2

> 笔记
>
> ns = 纳秒，μs = 微秒，ms = 毫秒
>
> 1 纳秒 = $10^{-9}$ 秒
>
> 1 µs= $10^{-6}$ 秒 = 1,000 ns
>
> 1 毫秒 = $10^{-3}$ 秒 = 1,000 微秒 = 1,000,000 纳秒
>
> 一位谷歌软件工程师开发了一个工具来可视化迪恩博士的数据。该工具还考虑了时间因素。图 2-1 显示了截至 2020 年的可视化延迟数字（图片来源：参考资料 [3]）。

![](./images/3/1.svg)

图1

通过分析图1中的数字，我们得到以下结论：

- 内存速度快，但磁盘速度慢。
- 如果可能的话，避免磁盘寻道。
- 简单的压缩算法速度很快。
- 如果可能的话，在通过互联网发送数据之前压缩数据。
- 数据中心通常位于不同的区域，它们之间传输数据需要时间。

## 可用号码

高可用性是系统在所需的较长时间内持续运行的能力。高可用性以百分比来衡量，100% 表示服务的停机时间为 0。大多数服务的利用率都在 99% 到 100% 之间。

服务级别协议 (SLA) 是服务提供商常用的术语。这是你（服务提供商）和你的客户之间的协议，该协议正式定义了你的服务将提供的正常运行时间水平。云提供商 Amazon [4]、Google [5] 和 Microsoft [6] 将其 SLA 设置为 99.9% 或以上。正常运行时间传统上以九为单位来衡量。九越多越好。如表 3 所示，9 的数量与预期的系统停机时间相关。

| **可用性 ％** | **每天的停机时间** | **每周停机时间** | **每月停机时间** | **每年停机时间** |
| ------------- | ------------------ | ---------------- | ---------------- | ---------------- |
| 99%           | 14.40 分钟         | 1.68小时         | 7.31小时         | 3.65天           |
| 99.99%        | 8.64秒             | 1.01分钟         | 4.38分钟         | 52.60 分钟       |
| 99.999%       | 864.00             | 6.05秒           | 26.30 秒         | 5.26分钟         |
| 99.9999%      | 86.40 毫秒         | 604.80           | 2.63秒           | 31.56秒          |

表3

## 示例：估计 Twitter QPS 和存储要求

请注意，以下数字仅用于本练习，因为它们不是来自 Twitter 的真实数字。

假设：

- 月活跃用户3亿。
- 50% 的用户每天使用 Twitter。
- 用户平均每天发布 2 条推文。
- 10% 的推文包含媒体内容。
- 数据保存5年。

估计：

每秒查询 (QPS) 估计：

- 日活跃用户 (DAU) = 3 亿 * 50% = 1.5 亿
- 推文 QPS = 1.5 亿 * 2 条推文 / 24 小时 / 3600 秒 = ~3500
- 峰值 QPS = 2 * QPS = ~7000

我们在这里仅估计媒体存储。

- 平均推文大小：
- tweet_id 64 字节
- 文本 140 字节
- 媒体 1 MB
- 媒体存储：每天 1.5 亿 * 2 * 10% * 1 MB = 30 TB
- 5 年媒体存储：30 TB * 365 * 5 = ~55 PB

## 尖端

粗略估计就是关于过程的。解决问题比获得结果更重要。面试官可能会测试你解决问题的能力。以下是一些需要遵循的提示：

- 舍入和近似。面试时很难进行复杂的数学运算。例如，“99987 / 9.1”的结果是什么？无需花费宝贵的时间来解决复杂的数学问题。预计精度不高。使用整数和近似值对你有利。除法问题可以简化为：“100,000 / 10”。
- 写下你的假设。最好写下你的假设以供以后参考。
- 给你的单位贴上标签。当你写下“5”时，它是指 5 KB 还是 5 MB？你可能对此感到困惑。写下单位，因为“5 MB”有助于消除歧义。
- 常见的粗略估计：QPS、峰值 QPS、存储、缓存、服务器数量等。你可以在准备面试时练习这些计算。熟能生巧。

恭喜你已经走到这一步了！现在拍拍自己的背吧。好工作！

## 参考资料

[1] J. Dean.Google 专业提示：使用粗略计算来选择最佳设计：
[http://highscalability.com/blog/2011/1/26/google-pro-tip-use -信封背面计算-to-choo.html](http://highscalability.com/blog/2011/1/26/google-pro-tip-use-back-of-the-envelope-calculations-to-choo.html)

[2] 系统设计入门：
https://github.com/donnemartin/system-design-primer

[3] 每个程序员都应该知道的延迟数字：
https://colin-scott.github.io/personal_website/research/interactive_latency.html

[4] 亚马逊计算服务级别协议：
https://aws.amazon.com/compute/sla/

[5] 计算引擎服务级别协议 (SLA)： https:
[//cloud.google.com/compute/sla](https://cloud.google.com/compute/sla)

[6] Azure 服务的 SLA 摘要：
https://azure.microsoft.com/en-us/support/legal/sla/summary/